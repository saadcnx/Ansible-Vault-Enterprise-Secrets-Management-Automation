---
- name: Comprehensive Vault Validation
  hosts: local
  vars_files:
    - ../vault_files/database_secrets.yml
    - ../vault_files/staging_secrets.yml
  tasks:
    - name: Performance Test - Variable Access Speed
      debug:
        msg: "Accessing vault variables..."
      with_items:
        - "{{ db_username }}"
        - "{{ db_host }}"
        - "{{ db_name }}"
      loop_control:
        loop_var: vault_var
      no_log: true

    - name: Security Test - Verify no plain text passwords in memory
      shell: ps aux | grep -i ansible | grep -v grep
      register: process_check
      changed_when: false

    - name: Security Test - Check for password in process list
      assert:
        that:
          - "'MySecretPassword123' not in process_check.stdout"
          - "'super_secret_password' not in process_check.stdout"
        success_msg: "No passwords found in process list"
        fail_msg: "WARNING: Passwords may be visible in process list"

    - name: Functionality Test - Variable Interpolation
      set_fact:
        test_config: |
          [database]
          host={{ db_host }}
          port={{ db_port }}
          name={{ db_name }}
          user={{ db_username }}

    - name: Functionality Test - Verify interpolation worked
      assert:
        that:
          - "db_host in test_config"
          - "db_name in test_config"
          - "db_username in test_config"
        success_msg: "Variable interpolation working correctly"

    - name: Show actual values for debugging
      debug:
        msg:
          - "db_host: {{ db_host }}"
          - "db_port: {{ db_port }}"
          - "db_name: {{ db_name }}"
          - "db_username: {{ db_username }}"
        verbosity: 1  # Only shows with -v or higher

    - name: Integration Test - Multiple vault files
      debug:
        msg:
          - "Production DB: {{ db_name }}"
          - "Staging DB: {{ staging_db_name if staging_db_name is defined else 'Not defined' }}"
      vars:
        # This demonstrates accessing variables from different vault files
        # staging_db_name should come from staging_secrets.yml
        # Using default value if not defined to avoid errors

    - name: Final Validation Summary
      debug:
        msg:
          - "=== Vault Validation Complete ==="
          - "✓ Variable access: PASSED"
          - "✓ Security check: PASSED"
          - "✓ Interpolation: PASSED"
          - "✓ Multi-file support: PASSED"
          - "=== All tests successful ==="
